// RGB LED Pins
#define RED_PIN 26    // GPIO26 -> R
#define GREEN_PIN 27  // GPIO27 -> G
#define BLUE_PIN 14   // GPIO14 -> B
// GND -> -

#include <WiFi.h>
#include <WiFiManager.h>
#include <PubSubClient.h>
#include <ArduinoJson.h>
#include <time.h>
#include <Preferences.h>  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤

// Preferences ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
Preferences preferences;

// MQTT Configuration (HiveMQ Public Broker - Free)
const char* mqtt_server = "broker.hivemq.com";
const int mqtt_port = 1883;
const char* mqtt_topic = "mq2/sensor001/data";

// MQTT Client
WiFiClient espClient;
PubSubClient mqtt(espClient);
WiFiManager wifiManager;

// Web Server ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
#include <WebServer.h>
WebServer configServer(80);

// Pin Configuration
#define RESET_WIFI_PIN 0  // ‡∏õ‡∏∏‡πà‡∏° BOOT ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï WiFi
#define MQ2_PIN 35        // GPIO 35 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö MQ-2 Sensor (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å 34)

// Sensor info (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô Web Config)
String sensorId = "";  // ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å MAC Address
String sensorName = "MQ2 Sensor";
String sensorLocation = "Room A";

// Global Variables
uint16_t lastGasValue = 0;
unsigned long lastMqttPublish = 0;
const unsigned long mqttPublishInterval = 200; // Publish ‡∏ó‡∏∏‡∏Å 200ms

// Load/Save Config
void loadConfig() {
  preferences.begin("sensor", false);
  sensorName = preferences.getString("name", "MQ2 Sensor");
  sensorLocation = preferences.getString("location", "Room A");
  preferences.end();
}

void saveConfig() {
  preferences.begin("sensor", false);
  preferences.putString("name", sensorName);
  preferences.putString("location", sensorLocation);
  preferences.end();
  Serial.println("‚úÖ Config saved!");
}

// Web Config Handlers
void handleRoot() {
  String html = "<!DOCTYPE html><html><head><meta charset='UTF-8'>";
  html += "<meta name='viewport' content='width=device-width,initial-scale=1'>";
  html += "<title>MQ-2 Configuration</title>";
  html += "<style>";
  html += "*{margin:0;padding:0;box-sizing:border-box}";
  html += "body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#000;color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}";
  html += ".container{max-width:480px;width:100%}";
  html += ".header{text-align:center;margin-bottom:48px}";
  html += ".header h1{font-size:24px;font-weight:600;letter-spacing:-0.5px;margin-bottom:8px}";
  html += ".header p{color:#666;font-size:14px}";
  html += ".card{background:#111;border:1px solid #222;border-radius:16px;padding:32px;margin-bottom:24px}";
  html += ".info-row{display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid #222}";
  html += ".info-row:last-child{border-bottom:none}";
  html += ".info-label{color:#666;font-size:14px}";
  html += ".info-value{color:#fff;font-weight:500;font-family:monospace}";
  html += ".form-group{margin-bottom:24px}";
  html += ".form-group:last-child{margin-bottom:0}";
  html += "label{display:block;color:#999;font-size:13px;font-weight:500;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px}";
  html += "input{width:100%;background:#000;border:1px solid #333;border-radius:8px;padding:14px 16px;color:#fff;font-size:16px;transition:all 0.2s}";
  html += "input:focus{outline:none;border-color:#fff;background:#111}";
  html += "input::placeholder{color:#444}";
  html += ".btn{width:100%;background:#fff;color:#000;border:none;border-radius:8px;padding:16px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.2s;margin-top:8px}";
  html += ".btn:hover{background:#f0f0f0;transform:translateY(-1px)}";
  html += ".btn:active{transform:translateY(0)}";
  html += ".status{display:flex;align-items:center;justify-content:center;gap:12px;padding:16px;background:#0a0a0a;border:1px solid #1a1a1a;border-radius:12px;margin-top:24px}";
  html += ".status-dot{width:8px;height:8px;background:#0f0;border-radius:50%;animation:pulse 2s infinite}";
  html += ".status-text{color:#666;font-size:14px}";
  html += ".status-value{color:#fff;font-weight:600;font-family:monospace}";
  html += "@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}";
  html += "@media(max-width:480px){.card{padding:24px}}";
  html += "</style></head><body>";
  html += "<div class='container'>";
  html += "<div class='header'>";
  html += "<h1>MQ-2 Sensor Configuration</h1>";
  html += "<p>Configure your gas sensor settings</p>";
  html += "</div>";
  
  html += "<div class='card'>";
  html += "<div class='info-row'>";
  html += "<span class='info-label'>Sensor ID</span>";
  html += "<span class='info-value'>" + sensorId + "</span>";
  html += "</div>";
  html += "<div class='info-row'>";
  html += "<span class='info-label'>IP Address</span>";
  html += "<span class='info-value'>" + WiFi.localIP().toString() + "</span>";
  html += "</div>";
  html += "<div class='info-row'>";
  html += "<span class='info-label'>Signal</span>";
  html += "<span class='info-value'>" + String(WiFi.RSSI()) + " dBm</span>";
  html += "</div>";
  html += "</div>";
  
  html += "<div class='card'>";
  html += "<form action='/save' method='POST'>";
  html += "<div class='form-group'>";
  html += "<label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå</label>";
  html += "<input name='name' value='" + sensorName + "' placeholder='‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô' required>";
  html += "</div>";
  html += "<div class='form-group'>";
  html += "<label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</label>";
  html += "<input name='location' value='" + sensorLocation + "' placeholder='‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏ä‡∏±‡πâ‡∏ô 2' required>";
  html += "</div>";
  html += "<button type='submit' class='btn'>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>";
  html += "</form>";
  html += "</div>";
  
  html += "<div class='status'>";
  html += "<div class='status-dot'></div>";
  html += "<span class='status-text'>Current Value:</span>";
  html += "<span class='status-value'>" + String(lastGasValue) + " ADC</span>";
  html += "</div>";
  
  html += "</div>";
  html += "</body></html>";
  configServer.send(200, "text/html; charset=UTF-8", html);
}

void handleSave() {
  if (configServer.hasArg("name") && configServer.hasArg("location")) {
    sensorName = configServer.arg("name");
    sensorLocation = configServer.arg("location");
    saveConfig();
    
    String html = "<!DOCTYPE html><html><head><meta charset='UTF-8'>";
    html += "<meta name='viewport' content='width=device-width,initial-scale=1'>";
    html += "<meta http-equiv='refresh' content='2;url=/'>";
    html += "<style>";
    html += "*{margin:0;padding:0;box-sizing:border-box}";
    html += "body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#000;color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}";
    html += ".success{text-align:center}";
    html += ".checkmark{width:80px;height:80px;border-radius:50%;background:#0f0;margin:0 auto 24px;display:flex;align-items:center;justify-content:center;font-size:48px;animation:scaleIn 0.3s ease-out}";
    html += "h2{font-size:24px;font-weight:600;margin-bottom:8px}";
    html += "p{color:#666;font-size:14px}";
    html += "@keyframes scaleIn{from{transform:scale(0)}to{transform:scale(1)}}";
    html += "</style></head><body>";
    html += "<div class='success'>";
    html += "<div class='checkmark'>‚úì</div>";
    html += "<h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h2>";
    html += "<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å...</p>";
    html += "</div>";
    html += "</body></html>";
    configServer.send(200, "text/html; charset=UTF-8", html);
  } else {
    configServer.send(400, "text/plain", "Missing parameters");
  }
}

// Get Timestamp
String getTimestamp() {
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo)) {
    return "2026-02-14 00:00:00";
  }
  char timeString[20];
  strftime(timeString, sizeof(timeString), "%Y-%m-%d %H:%M:%S", &timeinfo);
  return String(timeString);
}

// MQTT Reconnect
void reconnectMQTT() {
  while (!mqtt.connected()) {
    Serial.print("Connecting to MQTT...");
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á client ID ‡πÅ‡∏ö‡∏ö unique
    String clientId = "ESP32_MQ2_";
    clientId += String(random(0xffff), HEX);
    
    if (mqtt.connect(clientId.c_str())) {
      Serial.println(" Connected!");
      
      // ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      for (int i = 0; i < 2; i++) {
        digitalWrite(GREEN_PIN, HIGH);
        delay(100);
        digitalWrite(GREEN_PIN, LOW);
        delay(100);
      }
    } else {
      Serial.print(" Failed, rc=");
      Serial.print(mqtt.state());
      Serial.println(" Retrying in 5s...");
      
      // ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏™‡∏µ‡πÅ‡∏î‡∏á
      digitalWrite(RED_PIN, HIGH);
      delay(5000);
      digitalWrite(RED_PIN, LOW);
    }
  }
}

// Publish Sensor Data to MQTT
void publishSensorData(int value) {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô publish
  if (!mqtt.connected()) {
    Serial.println("MQTT disconnected, reconnecting...");
    reconnectMQTT();
    return;
  }
  
  StaticJsonDocument<256> doc;
  doc["id"] = sensorId.c_str();
  doc["name"] = sensorName.c_str();
  doc["location"] = sensorLocation.c_str();
  doc["value"] = value;
  doc["unit"] = "ADC";
  doc["timestamp"] = getTimestamp();
  doc["isOnline"] = true;
  
  String json;
  serializeJson(doc, json);
  
  // ‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
  if (!mqtt.publish(mqtt_topic, json.c_str(), false)) {
    delay(50);
    if (!mqtt.publish(mqtt_topic, json.c_str(), false)) {
      Serial.println("‚úó Publish failed!");
    }
  }
}


// Check Reset Button
void checkResetButton() {
  static unsigned long pressStart = 0;
  static bool wasPressed = false;
  
  if (digitalRead(RESET_WIFI_PIN) == LOW) {
    if (!wasPressed) {
      pressStart = millis();
      wasPressed = true;
    } else if (millis() - pressStart > 3000) {
      Serial.println("Reset WiFi settings...");
      wifiManager.resetSettings();
      Serial.println("WiFi settings cleared! Restarting...");
      delay(1000);
      ESP.restart();
    }
  } else {
    wasPressed = false;
  }
}

// Connect WiFi
void connectWiFi() {
  Serial.println("=== WiFiManager Setup ===");
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Sensor ID ‡∏à‡∏≤‡∏Å MAC Address (unique ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß)
  if (sensorId == "") {
    uint8_t mac[6];
    WiFi.macAddress(mac);
    sensorId = "MQ2-" + String(mac[3], HEX) + String(mac[4], HEX) + String(mac[5], HEX);
    sensorId.toUpperCase();
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ WiFi credentials ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (WiFi.SSID() != "") {
    Serial.print("‡∏û‡∏ö WiFi ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ: ");
    Serial.println(WiFi.SSID());
    Serial.println("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...");
  } else {
    Serial.println("‡πÑ‡∏°‡πà‡∏û‡∏ö WiFi ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ");
  }
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ timeout
  wifiManager.setConfigPortalTimeout(300);
  wifiManager.setConnectTimeout(30);
  wifiManager.setDebugOutput(true);
  
  Serial.println("‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Access Point: MQ2-Sensor-Setup");
  Serial.println("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° BOOT ‡∏Ñ‡πâ‡∏≤‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö WiFi settings");
  
  if (!wifiManager.autoConnect("MQ2-Sensor-Setup")) {
    Serial.println("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WiFi ‡πÑ‡∏î‡πâ");
    Serial.println("‡∏Å‡∏≥‡∏•‡∏±‡∏á restart...");
    delay(3000);
    ESP.restart();
  }
  
  Serial.println("========================================");
  Serial.println("‚úÖ WiFi Connected!");
  Serial.print("SSID: ");
  Serial.println(WiFi.SSID());
  Serial.print("IP Address: ");
  Serial.println(WiFi.localIP());
  Serial.print("Signal Strength: ");
  Serial.print(WiFi.RSSI());
  Serial.println(" dBm");
  Serial.println("========================================");
  Serial.println("üìç Sensor Configuration:");
  Serial.print("ID (Auto): ");
  Serial.println(sensorId);
  Serial.print("Name: ");
  Serial.println(sensorName);
  Serial.print("Location: ");
  Serial.println(sensorLocation);
  Serial.println("========================================");
  Serial.println("üåê Config URL: http://" + WiFi.localIP().toString());
  Serial.println("========================================");
}

void setup() {
  Serial.begin(115200);
  delay(200);
  
  pinMode(RESET_WIFI_PIN, INPUT_PULLUP);
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ RGB pins ‡πÄ‡∏õ‡πá‡∏ô OUTPUT
  pinMode(RED_PIN, OUTPUT);
  pinMode(GREEN_PIN, OUTPUT);
  pinMode(BLUE_PIN, OUTPUT);
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô)
  digitalWrite(RED_PIN, LOW);
  digitalWrite(GREEN_PIN, LOW);
  digitalWrite(BLUE_PIN, HIGH);
  
  Serial.println("=== MQ-2 Sensor System with MQTT ===");
  
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
  loadConfig();
  
  // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WiFi
  connectWiFi();
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤
  if (WiFi.status() == WL_CONNECTED) {
    configTime(7 * 3600, 0, "pool.ntp.org");
  }
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web Server ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Config
  configServer.on("/", handleRoot);
  configServer.on("/save", HTTP_POST, handleSave);
  configServer.begin();
  Serial.println("‚úÖ Config Server started!");
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ MQTT
  mqtt.setServer(mqtt_server, mqtt_port);
  mqtt.setKeepAlive(60);
  mqtt.setSocketTimeout(30);
  
  Serial.println("MQTT Configuration:");
  Serial.print("Server: ");
  Serial.println(mqtt_server);
  Serial.print("Topic: ");
  Serial.println(mqtt_topic);
  
  // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MQTT
  reconnectMQTT();
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö)
  for (int i = 0; i < 3; i++) {
    digitalWrite(RED_PIN, LOW);
    digitalWrite(GREEN_PIN, HIGH);
    digitalWrite(BLUE_PIN, LOW);
    delay(200);
    digitalWrite(GREEN_PIN, LOW);
    delay(200);
  }
  
  Serial.println("System Ready!");
}

void loop() {
  // Handle Web Server
  configServer.handleClient();
  
  // ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MQTT
  if (!mqtt.connected()) {
    reconnectMQTT();
  }
  mqtt.loop();
  
  checkResetButton();
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö WiFi
  static unsigned long lastWiFiCheck = 0;
  if (millis() - lastWiFiCheck > 30000) {
    if (WiFi.status() != WL_CONNECTED) {
      Serial.println("WiFi disconnected! Reconnecting...");
      WiFi.reconnect();
    }
    lastWiFiCheck = millis();
  }
  
  // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ Sensor
  int val = analogRead(MQ2_PIN);
  lastGasValue = val;
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Serial Monitor ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π baseline
//   Serial.print("MQ-2 Value: ");
//   Serial.print(val);
//   Serial.print(" | LED should be: ");
  
  // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏≠‡∏∞‡πÑ‡∏£
  if (val < 70) {
    Serial.println("GREEN");
  } else if (val <= 150) {
    Serial.println("YELLOW");
  } else {
    Serial.println("RED");
  }
  
  // Publish ‡πÑ‡∏õ‡∏¢‡∏±‡∏á MQTT ‡∏ó‡∏∏‡∏Å 200ms
  if (millis() - lastMqttPublish >= mqttPublishInterval) {
    publishSensorData(val);
    lastMqttPublish = millis();
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
  // Threshold ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á MQ-2
  // < 70 = ‡∏õ‡∏Å‡∏ï‡∏¥, 70-150 = ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á, > 150 = ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
  
  // ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
  digitalWrite(RED_PIN, LOW);
  digitalWrite(GREEN_PIN, LOW);
  digitalWrite(BLUE_PIN, LOW);
  
  if (val < 70) {
    // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß - ‡∏õ‡∏Å‡∏ï‡∏¥
    digitalWrite(GREEN_PIN, HIGH);
  } 
  else if (val >= 70 && val <= 150) {
    // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á - ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á
    digitalWrite(RED_PIN, HIGH);
    digitalWrite(GREEN_PIN, HIGH);
  } 
  else {
    // ‡∏™‡∏µ‡πÅ‡∏î‡∏á - ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
    digitalWrite(RED_PIN, HIGH);
  }
  
  delay(50); // ‡∏•‡∏î delay ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ MQTT loop ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ö‡πà‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
}

// ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:
// - MQ-2 ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏∏‡πà‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á 20-180 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Ñ‡πà‡∏≤‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£
// - ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 50ms
// - MQTT publish ‡∏ó‡∏∏‡∏Å 200ms ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡πÇ‡∏´‡∏•‡∏î network
