// RGB LED Pins
#define RED_PIN 26    // GPIO26 -> R
#define GREEN_PIN 27  // GPIO27 -> G
#define BLUE_PIN 14   // GPIO14 -> B
// GND -> -

#include <WiFi.h>
#include <WiFiManager.h>
#include <WiFiClientSecure.h>
#include <PubSubClient.h>
#include <ArduinoJson.h>
#include <time.h>
#include <Preferences.h>  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤

// Preferences ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
Preferences preferences;

// MQTT Configuration (HiveMQ Public Broker - Free)
const char* mqtt_server = "broker.hivemq.com";
const int mqtt_port = 1883;
const char* mqtt_topic = "mq2/sensor001/data";

// LINE Messaging API Configuration
const char* lineChannelToken = "sHf/1fMyEF2qJxt3u3ipdecE/P6JolfzaWRUWPCHaB9QqRKGfStSUNyvNtCo0oK4wy1Njdu97p0H6Cfu7a/5jCy1OTKJ3cVKmIDczgPG7r+HRvvMBSaz36JZ66stQN6QmoOm3GP463LeguKFppdKkwdB04t89/1O/w1cDnyilFU="; // ‡πÉ‡∏™‡πà Channel Access Token
const char* lineUserId = "U415f3ebdb0643946326ed242d827ed6a"; // ‡πÉ‡∏™‡πà User ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö
const char* lineApiHost = "api.line.me";
const int lineApiPort = 443;

// MQTT Client
WiFiClient espClient;
PubSubClient mqtt(espClient);
WiFiManager wifiManager;

// LINE Notify Client
WiFiClientSecure lineClient;

// Web Server ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
#include <WebServer.h>
WebServer configServer(80);

// Pin Configuration
#define RESET_WIFI_PIN 0  // ‡∏õ‡∏∏‡πà‡∏° BOOT ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï WiFi
#define MQ2_PIN 35        // GPIO 35 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö MQ-2 Sensor (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å 34)
#define POWER_SWITCH_PIN 4 // GPIO 4 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Switch ‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö

// Sensor info (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô Web Config)
String sensorId = "";  // ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å MAC Address
String sensorName = "MQ2 Sensor";
String sensorLocation = "Room A";

// Global Variables
uint16_t lastGasValue = 0;
unsigned long lastMqttPublish = 0;
const unsigned long mqttPublishInterval = 200; // Publish ‡∏ó‡∏∏‡∏Å 200ms

// Statistics Variables
int dailyReadings = 0;
long dailySum = 0;
int dailyMax = 0;
int exceedCount = 0; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô 70 ADC
unsigned long lastDailySummary = 0;
const unsigned long dailySummaryInterval = 86400000; // 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á

// Moving Average Filter
const int numReadings = 30; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 30 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£
int readings[numReadings];
int readIndex = 0;
int total = 0;
int average = 0;

// Calibration
int baselineValue = 0;
bool isCalibrated = false;

// LINE Notify Variables
unsigned long lastLineNotify = 0;
const unsigned long lineNotifyInterval = 60000; // ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ (60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
const unsigned long criticalNotifyInterval = 30000; // ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
bool warningNotified = false;
bool dangerNotified = false;
int lastNotifiedLevel = 0; // 0=‡∏õ‡∏Å‡∏ï‡∏¥, 1=‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á, 2=‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢

// Load/Save Config
void loadConfig() {
  preferences.begin("sensor", false);
  sensorName = preferences.getString("name", "MQ2 Sensor");
  sensorLocation = preferences.getString("location", "Room A");
  preferences.end();
}

void saveConfig() {
  preferences.begin("sensor", false);
  preferences.putString("name", sensorName);
  preferences.putString("location", sensorLocation);
  preferences.end();
  Serial.println("‚úÖ Config saved!");
}

// Web Config Handlers
void handleRoot() {
  String html = "<!DOCTYPE html><html><head><meta charset='UTF-8'>";
  html += "<meta name='viewport' content='width=device-width,initial-scale=1'>";
  html += "<title>MQ-2 Configuration</title>";
  html += "<style>";
  html += "*{margin:0;padding:0;box-sizing:border-box}";
  html += "body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#000;color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}";
  html += ".container{max-width:480px;width:100%}";
  html += ".header{text-align:center;margin-bottom:48px}";
  html += ".header h1{font-size:24px;font-weight:600;letter-spacing:-0.5px;margin-bottom:8px}";
  html += ".header p{color:#666;font-size:14px}";
  html += ".card{background:#111;border:1px solid #222;border-radius:16px;padding:32px;margin-bottom:24px}";
  html += ".info-row{display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid #222}";
  html += ".info-row:last-child{border-bottom:none}";
  html += ".info-label{color:#666;font-size:14px}";
  html += ".info-value{color:#fff;font-weight:500;font-family:monospace}";
  html += ".form-group{margin-bottom:24px}";
  html += ".form-group:last-child{margin-bottom:0}";
  html += "label{display:block;color:#999;font-size:13px;font-weight:500;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px}";
  html += "input{width:100%;background:#000;border:1px solid #333;border-radius:8px;padding:14px 16px;color:#fff;font-size:16px;transition:all 0.2s}";
  html += "input:focus{outline:none;border-color:#fff;background:#111}";
  html += "input::placeholder{color:#444}";
  html += ".btn{width:100%;background:#fff;color:#000;border:none;border-radius:8px;padding:16px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.2s;margin-top:8px}";
  html += ".btn:hover{background:#f0f0f0;transform:translateY(-1px)}";
  html += ".btn:active{transform:translateY(0)}";
  html += ".status{display:flex;align-items:center;justify-content:center;gap:12px;padding:16px;background:#0a0a0a;border:1px solid #1a1a1a;border-radius:12px;margin-top:24px}";
  html += ".status-dot{width:8px;height:8px;background:#0f0;border-radius:50%;animation:pulse 2s infinite}";
  html += ".status-text{color:#666;font-size:14px}";
  html += ".status-value{color:#fff;font-weight:600;font-family:monospace}";
  html += "@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}";
  html += "@media(max-width:480px){.card{padding:24px}}";
  html += "</style></head><body>";
  html += "<div class='container'>";
  html += "<div class='header'>";
  html += "<h1>MQ-2 Sensor Configuration</h1>";
  html += "<p>Configure your gas sensor settings</p>";
  html += "</div>";
  
  html += "<div class='card'>";
  html += "<div class='info-row'>";
  html += "<span class='info-label'>Sensor ID</span>";
  html += "<span class='info-value'>" + sensorId + "</span>";
  html += "</div>";
  html += "<div class='info-row'>";
  html += "<span class='info-label'>IP Address</span>";
  html += "<span class='info-value'>" + WiFi.localIP().toString() + "</span>";
  html += "</div>";
  html += "<div class='info-row'>";
  html += "<span class='info-label'>Signal</span>";
  html += "<span class='info-value'>" + String(WiFi.RSSI()) + " dBm</span>";
  html += "</div>";
  html += "</div>";
  
  html += "<div class='card'>";
  html += "<form action='/save' method='POST'>";
  html += "<div class='form-group'>";
  html += "<label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå</label>";
  html += "<input name='name' value='" + sensorName + "' placeholder='‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô' required>";
  html += "</div>";
  html += "<div class='form-group'>";
  html += "<label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</label>";
  html += "<input name='location' value='" + sensorLocation + "' placeholder='‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏ä‡∏±‡πâ‡∏ô 2' required>";
  html += "</div>";
  html += "<button type='submit' class='btn'>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>";
  html += "</form>";
  html += "</div>";
  
  html += "<div class='status'>";
  html += "<div class='status-dot'></div>";
  html += "<span class='status-text'>Current Value:</span>";
  html += "<span class='status-value'>" + String(lastGasValue) + " ADC</span>";
  html += "</div>";
  
  html += "</div>";
  html += "</body></html>";
  configServer.send(200, "text/html; charset=UTF-8", html);
}

void handleSave() {
  if (configServer.hasArg("name") && configServer.hasArg("location")) {
    sensorName = configServer.arg("name");
    sensorLocation = configServer.arg("location");
    saveConfig();
    
    String html = "<!DOCTYPE html><html><head><meta charset='UTF-8'>";
    html += "<meta name='viewport' content='width=device-width,initial-scale=1'>";
    html += "<meta http-equiv='refresh' content='2;url=/'>";
    html += "<style>";
    html += "*{margin:0;padding:0;box-sizing:border-box}";
    html += "body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#000;color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}";
    html += ".success{text-align:center}";
    html += ".checkmark{width:80px;height:80px;border-radius:50%;background:#0f0;margin:0 auto 24px;display:flex;align-items:center;justify-content:center;font-size:48px;animation:scaleIn 0.3s ease-out}";
    html += "h2{font-size:24px;font-weight:600;margin-bottom:8px}";
    html += "p{color:#666;font-size:14px}";
    html += "@keyframes scaleIn{from{transform:scale(0)}to{transform:scale(1)}}";
    html += "</style></head><body>";
    html += "<div class='success'>";
    html += "<div class='checkmark'>‚úì</div>";
    html += "<h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h2>";
    html += "<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å...</p>";
    html += "</div>";
    html += "</body></html>";
    configServer.send(200, "text/html; charset=UTF-8", html);
  } else {
    configServer.send(400, "text/plain", "Missing parameters");
  }
}

// Get Timestamp
String getTimestamp() {
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo)) {
    return "2026-02-14 00:00:00";
  }
  char timeString[20];
  strftime(timeString, sizeof(timeString), "%Y-%m-%d %H:%M:%S", &timeinfo);
  return String(timeString);
}

// MQTT Reconnect
void reconnectMQTT() {
  // ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà loop
  if (!mqtt.connected()) {
    Serial.print("Connecting to MQTT...");
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á client ID ‡πÅ‡∏ö‡∏ö unique
    String clientId = "ESP32_MQ2_";
    clientId += String(random(0xffff), HEX);
    
    if (mqtt.connect(clientId.c_str())) {
      Serial.println(" Connected!");
    } else {
      Serial.print(" Failed, rc=");
      Serial.println(mqtt.state());
    }
  }
}

// Publish Sensor Data to MQTT
void publishSensorData(int value) {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô publish
  if (!mqtt.connected()) {
    return; // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reconnect ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÉ‡∏´‡πâ loop() ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
  }
  
  StaticJsonDocument<256> doc;
  doc["id"] = sensorId.c_str();
  doc["name"] = sensorName.c_str();
  doc["location"] = sensorLocation.c_str();
  doc["value"] = value;
  doc["unit"] = "ADC";
  doc["timestamp"] = getTimestamp();
  doc["isOnline"] = true;
  
  String json;
  serializeJson(doc, json);
  
  // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö non-blocking ‡πÑ‡∏°‡πà retry
  mqtt.publish(mqtt_topic, json.c_str(), false);
}

// Send LINE Message via Messaging API (Optimized - Non-blocking)
void sendLineMessage(String message) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("‚ùå WiFi not connected");
    return;
  }
  
  lineClient.setInsecure();
  lineClient.setTimeout(2000); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  
  Serial.println("üì± Sending LINE...");
  
  if (!lineClient.connect(lineApiHost, lineApiPort)) {
    Serial.println("‚ùå Connection failed");
    lineClient.stop();
    return;
  }
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á JSON payload
  StaticJsonDocument<512> doc;
  doc["to"] = lineUserId;
  
  JsonArray messages = doc.createNestedArray("messages");
  JsonObject textMessage = messages.createNestedObject();
  textMessage["type"] = "text";
  textMessage["text"] = message;
  
  String payload;
  serializeJson(doc, payload);
  
  // ‡∏™‡πà‡∏á HTTP Request
  lineClient.println("POST /v2/bot/message/push HTTP/1.1");
  lineClient.println("Host: " + String(lineApiHost));
  lineClient.println("Authorization: Bearer " + String(lineChannelToken));
  lineClient.println("Content-Type: application/json");
  lineClient.println("Content-Length: " + String(payload.length()));
  lineClient.println("Connection: close");
  lineClient.println();
  lineClient.print(payload);
  
  // ‡∏≠‡πà‡∏≤‡∏ô response ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å (‡∏£‡∏≠‡πÅ‡∏Ñ‡πà 1000ms)
  unsigned long timeout = millis();
  bool success = false;
  
  while (lineClient.connected() && millis() - timeout < 1000) { // ‡∏£‡∏≠ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    if (lineClient.available()) {
      String line = lineClient.readStringUntil('\n');
      if (line.indexOf("200") >= 0) {
        success = true;
        break;
      }
    }
    yield(); // ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ
  }
  
  lineClient.stop();
  
  if (success) {
    Serial.println("‚úÖ Sent");
  } else {
    Serial.println("‚ö†Ô∏è Sent (timeout)");
  }
}

// Send LINE Flex Message with Color (World-Class Design)
void sendLineFlexMessage(String level, String color, int value) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("‚ùå WiFi not connected");
    return;
  }
  
  lineClient.setInsecure();
  lineClient.setTimeout(2000);
  
  Serial.println("üì± Sending LINE Flex...");
  
  if (!lineClient.connect(lineApiHost, lineApiPort)) {
    Serial.println("‚ùå Connection failed");
    lineClient.stop();
    return;
  }
  
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö
  String statusText = "";
  String actionText = "";
  String thresholdText = "";
  
  if (value >= 300) {
    statusText = "‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å";
    actionText = "‡∏≠‡∏û‡∏¢‡∏û‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ";
    thresholdText = ">300 ADC";
  } else if (value >= 151) {
    statusText = "‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô";
    actionText = "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®";
    thresholdText = "151-300 ADC";
  } else if (value >= 70) {
    statusText = "‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥";
    actionText = "‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå";
    thresholdText = "70-150 ADC";
  } else {
    statusText = "‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢";
    actionText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏õ‡∏Å‡∏ï‡∏¥";
    thresholdText = "<70 ADC";
  }
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message JSON (World-Class Design)
  StaticJsonDocument<2048> doc;
  doc["to"] = lineUserId;
  
  JsonArray messages = doc.createNestedArray("messages");
  JsonObject flexMessage = messages.createNestedObject();
  flexMessage["type"] = "flex";
  flexMessage["altText"] = level + " - " + sensorLocation;
  
  JsonObject contents = flexMessage.createNestedObject("contents");
  contents["type"] = "bubble";
  
  // Header - Clean & Bold
  JsonObject header = contents.createNestedObject("header");
  header["type"] = "box";
  header["layout"] = "vertical";
  header["backgroundColor"] = color;
  header["paddingAll"] = "20px";
  
  JsonArray headerContents = header.createNestedArray("contents");
  JsonObject headerText = headerContents.createNestedObject();
  headerText["type"] = "text";
  headerText["text"] = level;
  headerText["color"] = "#FFFFFF";
  headerText["weight"] = "bold";
  headerText["size"] = "xl";
  headerText["align"] = "center";
  
  // Body - Information Hierarchy
  JsonObject body = contents.createNestedObject("body");
  body["type"] = "box";
  body["layout"] = "vertical";
  body["spacing"] = "lg";
  body["paddingAll"] = "20px";
  
  JsonArray bodyContents = body.createNestedArray("contents");
  
  // Value Display - Hero Section
  JsonObject valueSection = bodyContents.createNestedObject();
  valueSection["type"] = "box";
  valueSection["layout"] = "vertical";
  valueSection["spacing"] = "xs";
  valueSection["paddingAll"] = "16px";
  valueSection["backgroundColor"] = "#F7F7F7";
  valueSection["cornerRadius"] = "8px";
  
  JsonArray valueSectionContents = valueSection.createNestedArray("contents");
  
  JsonObject valueLabel = valueSectionContents.createNestedObject();
  valueLabel["type"] = "text";
  valueLabel["text"] = "‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ";
  valueLabel["size"] = "xs";
  valueLabel["color"] = "#999999";
  valueLabel["align"] = "center";
  
  JsonObject valueDisplay = valueSectionContents.createNestedObject();
  valueDisplay["type"] = "text";
  valueDisplay["text"] = String(value) + " ADC";
  valueDisplay["size"] = "xxl";
  valueDisplay["weight"] = "bold";
  valueDisplay["color"] = color;
  valueDisplay["align"] = "center";
  
  // Status
  JsonObject statusBox = bodyContents.createNestedObject();
  statusBox["type"] = "box";
  statusBox["layout"] = "vertical";
  statusBox["spacing"] = "xs";
  
  JsonArray statusContents = statusBox.createNestedArray("contents");
  
  JsonObject statusLabelObj = statusContents.createNestedObject();
  statusLabelObj["type"] = "text";
  statusLabelObj["text"] = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞";
  statusLabelObj["size"] = "xs";
  statusLabelObj["color"] = "#999999";
  
  JsonObject statusValueObj = statusContents.createNestedObject();
  statusValueObj["type"] = "text";
  statusValueObj["text"] = statusText;
  statusValueObj["size"] = "sm";
  statusValueObj["weight"] = "bold";
  
  // Action Required
  JsonObject actionBox = bodyContents.createNestedObject();
  actionBox["type"] = "box";
  actionBox["layout"] = "vertical";
  actionBox["spacing"] = "xs";
  
  JsonArray actionContents = actionBox.createNestedArray("contents");
  
  JsonObject actionLabelObj = actionContents.createNestedObject();
  actionLabelObj["type"] = "text";
  actionLabelObj["text"] = "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥";
  actionLabelObj["size"] = "xs";
  actionLabelObj["color"] = "#999999";
  
  JsonObject actionValueObj = actionContents.createNestedObject();
  actionValueObj["type"] = "text";
  actionValueObj["text"] = actionText;
  actionValueObj["size"] = "sm";
  actionValueObj["wrap"] = true;
  
  // Separator
  JsonObject separator = bodyContents.createNestedObject();
  separator["type"] = "separator";
  separator["margin"] = "lg";
  
  // Location
  JsonObject locationBox = bodyContents.createNestedObject();
  locationBox["type"] = "box";
  locationBox["layout"] = "vertical";
  locationBox["spacing"] = "xs";
  locationBox["margin"] = "lg";
  
  JsonArray locationContents = locationBox.createNestedArray("contents");
  
  JsonObject locationLabelObj = locationContents.createNestedObject();
  locationLabelObj["type"] = "text";
  locationLabelObj["text"] = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà";
  locationLabelObj["size"] = "xs";
  locationLabelObj["color"] = "#999999";
  
  JsonObject locationValueObj = locationContents.createNestedObject();
  locationValueObj["type"] = "text";
  locationValueObj["text"] = sensorLocation;
  locationValueObj["size"] = "sm";
  locationValueObj["wrap"] = true;
  
  // Footer - Metadata
  JsonObject footer = contents.createNestedObject("footer");
  footer["type"] = "box";
  footer["layout"] = "vertical";
  footer["spacing"] = "xs";
  footer["paddingAll"] = "16px";
  
  JsonArray footerContents = footer.createNestedArray("contents");
  
  JsonObject timeText = footerContents.createNestedObject();
  timeText["type"] = "text";
  timeText["text"] = getTimestamp();
  timeText["size"] = "xxs";
  timeText["color"] = "#AAAAAA";
  
  JsonObject sensorText = footerContents.createNestedObject();
  sensorText["type"] = "text";
  sensorText["text"] = "Sensor ID: " + sensorId;
  sensorText["size"] = "xxs";
  sensorText["color"] = "#AAAAAA";
  
  String payload;
  serializeJson(doc, payload);
  
  // ‡∏™‡πà‡∏á HTTP Request
  lineClient.println("POST /v2/bot/message/push HTTP/1.1");
  lineClient.println("Host: " + String(lineApiHost));
  lineClient.println("Authorization: Bearer " + String(lineChannelToken));
  lineClient.println("Content-Type: application/json");
  lineClient.println("Content-Length: " + String(payload.length()));
  lineClient.println("Connection: close");
  lineClient.println();
  lineClient.print(payload);
  
  // ‡∏≠‡πà‡∏≤‡∏ô response
  unsigned long timeout = millis();
  while (lineClient.connected() && millis() - timeout < 1000) {
    if (lineClient.available()) {
      String line = lineClient.readStringUntil('\n');
      if (line.indexOf("200") >= 0) {
        Serial.println("‚úÖ Sent Flex");
        break;
      }
    }
    yield();
  }
  
  lineClient.stop();
}

// Check and Send Alert
void checkAndSendAlert(int value) {
  unsigned long currentTime = millis();
  static int lastLevel = 0; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  int currentLevel = 0;
  
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏° Hysteresis (‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏î‡πâ‡∏á)
  if (lastLevel == 0) {
    // ‡∏à‡∏≤‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥ -> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏¥‡∏ô 75 ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á
    if (value < 75) {
      currentLevel = 0; // ‡∏õ‡∏Å‡∏ï‡∏¥
    } else if (value >= 75 && value <= 155) {
      currentLevel = 1; // ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á
    } else if (value > 155 && value <= 305) {
      currentLevel = 2; // ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
    } else {
      currentLevel = 3; // ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï (>305)
    }
  } else if (lastLevel == 1) {
    // ‡∏à‡∏≤‡∏Å‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á -> ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 65 ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥, ‡πÄ‡∏Å‡∏¥‡∏ô 155 ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
    if (value < 65) {
      currentLevel = 0; // ‡∏õ‡∏Å‡∏ï‡∏¥
    } else if (value >= 65 && value <= 155) {
      currentLevel = 1; // ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á
    } else if (value > 155 && value <= 305) {
      currentLevel = 2; // ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
    } else {
      currentLevel = 3; // ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï
    }
  } else if (lastLevel == 2) {
    // ‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ -> ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 145 ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á, ‡πÄ‡∏Å‡∏¥‡∏ô 305 ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏¥‡∏Å‡∏§‡∏ï
    if (value < 145) {
      currentLevel = 1; // ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á
    } else if (value >= 145 && value <= 305) {
      currentLevel = 2; // ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
    } else {
      currentLevel = 3; // ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï
    }
  } else if (lastLevel == 3) {
    // ‡∏à‡∏≤‡∏Å‡∏ß‡∏¥‡∏Å‡∏§‡∏ï -> ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 295 ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
    if (value < 295) {
      currentLevel = 2; // ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
    } else {
      currentLevel = 3; // ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï
    }
  }
  
  // ‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠:
  // 1. ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
  // 2. ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢/‡∏ß‡∏¥‡∏Å‡∏§‡∏ï ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏° interval
  bool shouldSend = false;
  
  if (currentLevel != lastLevel) {
    // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô - ‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    shouldSend = true;
  } else if (currentLevel >= 2) {
    // ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢/‡∏ß‡∏¥‡∏Å‡∏§‡∏ï - ‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡∏ï‡∏≤‡∏° interval
    unsigned long interval = (currentLevel == 3) ? criticalNotifyInterval : lineNotifyInterval;
    if (currentTime - lastLineNotify >= interval) {
      shouldSend = true;
    }
  }
  
  if (!shouldSend) {
    return;
  }
  
  String alertMessage = "";
  
  if (currentLevel == 3) {
    // ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï
    alertMessage = "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    alertMessage += "   ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô\n";
    alertMessage += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
    alertMessage += "‡∏£‡∏∞‡∏î‡∏±‡∏ö: ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï\n";
    alertMessage += "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: " + sensorLocation + "\n";
    alertMessage += "‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î: " + String(value) + " ADC\n";
    alertMessage += "‡πÄ‡∏Å‡∏ì‡∏ë‡πå: >300 ADC\n";
    alertMessage += "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å\n";
    alertMessage += "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏û‡∏¢‡∏û‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ\n\n";
    alertMessage += "‡πÄ‡∏ß‡∏•‡∏≤: " + getTimestamp() + "\n";
    alertMessage += "Sensor ID: " + sensorId;
  }
  else if (currentLevel == 2) {
    // ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
    alertMessage = "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    alertMessage += "  ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢\n";
    alertMessage += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
    alertMessage += "‡∏£‡∏∞‡∏î‡∏±‡∏ö: ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢\n";
    alertMessage += "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: " + sensorLocation + "\n";
    alertMessage += "‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î: " + String(value) + " ADC\n";
    alertMessage += "‡πÄ‡∏Å‡∏ì‡∏ë‡πå: 151-300 ADC\n";
    alertMessage += "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô\n";
    alertMessage += "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®\n\n";
    alertMessage += "‡πÄ‡∏ß‡∏•‡∏≤: " + getTimestamp() + "\n";
    alertMessage += "Sensor ID: " + sensorId;
  } 
  else if (currentLevel == 1) {
    // ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á
    alertMessage = "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    alertMessage += "  ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á\n";
    alertMessage += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
    alertMessage += "‡∏£‡∏∞‡∏î‡∏±‡∏ö: ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á\n";
    alertMessage += "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: " + sensorLocation + "\n";
    alertMessage += "‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î: " + String(value) + " ADC\n";
    alertMessage += "‡πÄ‡∏Å‡∏ì‡∏ë‡πå: 70-150 ADC\n";
    alertMessage += "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥\n";
    alertMessage += "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå\n\n";
    alertMessage += "‡πÄ‡∏ß‡∏•‡∏≤: " + getTimestamp() + "\n";
    alertMessage += "Sensor ID: " + sensorId;
  }
  else if (currentLevel == 0 && lastLevel > 0) {
    // ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏õ‡∏Å‡∏ï‡∏¥
    alertMessage = "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    alertMessage += "   ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥\n";
    alertMessage += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
    alertMessage += "‡∏£‡∏∞‡∏î‡∏±‡∏ö: ‡∏õ‡∏Å‡∏ï‡∏¥\n";
    alertMessage += "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: " + sensorLocation + "\n";
    alertMessage += "‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î: " + String(value) + " ADC\n";
    alertMessage += "‡πÄ‡∏Å‡∏ì‡∏ë‡πå: <70 ADC\n";
    alertMessage += "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢\n\n";
    alertMessage += "‡πÄ‡∏ß‡∏•‡∏≤: " + getTimestamp() + "\n";
    alertMessage += "Sensor ID: " + sensorId;
  }
  
  if (alertMessage != "") {
    // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö Flex Message (‡∏°‡∏µ‡∏™‡∏µ)
    String levelText = "";
    String colorCode = "";
    
    if (currentLevel == 3) {
      levelText = "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô";
      colorCode = "#FF0000"; // ‡πÅ‡∏î‡∏á
    } else if (currentLevel == 2) {
      levelText = "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢";
      colorCode = "#FF6600"; // ‡∏™‡πâ‡∏°
    } else if (currentLevel == 1) {
      levelText = "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á";
      colorCode = "#FFB800"; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
    } else if (currentLevel == 0) {
      levelText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥";
      colorCode = "#00C851"; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    }
    
    sendLineFlexMessage(levelText, colorCode, value);
    lastLineNotify = currentTime;
    lastLevel = currentLevel;
  }
}


// Check Reset Button
void checkResetButton() {
  static unsigned long pressStart = 0;
  static bool wasPressed = false;
  
  if (digitalRead(RESET_WIFI_PIN) == LOW) {
    if (!wasPressed) {
      pressStart = millis();
      wasPressed = true;
    } else if (millis() - pressStart > 3000) {
      Serial.println("Reset WiFi settings...");
      wifiManager.resetSettings();
      Serial.println("WiFi settings cleared! Restarting...");
      delay(1000);
      ESP.restart();
    }
  } else {
    wasPressed = false;
  }
}

// Connect WiFi
void connectWiFi() {
  Serial.println("=== WiFiManager Setup ===");
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Sensor ID ‡∏à‡∏≤‡∏Å MAC Address (unique ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß)
  if (sensorId == "") {
    uint8_t mac[6];
    WiFi.macAddress(mac);
    sensorId = "MQ2-" + String(mac[3], HEX) + String(mac[4], HEX) + String(mac[5], HEX);
    sensorId.toUpperCase();
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ WiFi credentials ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (WiFi.SSID() != "") {
    Serial.print("‡∏û‡∏ö WiFi ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ: ");
    Serial.println(WiFi.SSID());
    Serial.println("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...");
  } else {
    Serial.println("‡πÑ‡∏°‡πà‡∏û‡∏ö WiFi ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ");
  }
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ timeout
  wifiManager.setConfigPortalTimeout(300);
  wifiManager.setConnectTimeout(30);
  wifiManager.setDebugOutput(true);
  
  Serial.println("‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Access Point: MQ2-Sensor-Setup");
  Serial.println("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° BOOT ‡∏Ñ‡πâ‡∏≤‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö WiFi settings");
  
  if (!wifiManager.autoConnect("MQ2-Sensor-Setup")) {
    Serial.println("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WiFi ‡πÑ‡∏î‡πâ");
    Serial.println("‡∏Å‡∏≥‡∏•‡∏±‡∏á restart...");
    delay(3000);
    ESP.restart();
  }
  
  Serial.println("========================================");
  Serial.println("‚úÖ WiFi Connected!");
  Serial.print("SSID: ");
  Serial.println(WiFi.SSID());
  Serial.print("IP Address: ");
  Serial.println(WiFi.localIP());
  Serial.print("Signal Strength: ");
  Serial.print(WiFi.RSSI());
  Serial.println(" dBm");
  Serial.println("========================================");
  Serial.println("üìç Sensor Configuration:");
  Serial.print("ID (Auto): ");
  Serial.println(sensorId);
  Serial.print("Name: ");
  Serial.println(sensorName);
  Serial.print("Location: ");
  Serial.println(sensorLocation);
  Serial.println("========================================");
  Serial.println("üåê Config URL: http://" + WiFi.localIP().toString());
  Serial.println("========================================");
}

void setup() {
  Serial.begin(115200);
  delay(200);
  
  pinMode(RESET_WIFI_PIN, INPUT_PULLUP);
  pinMode(POWER_SWITCH_PIN, INPUT_PULLUP); // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ switch pin
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ RGB pins ‡πÄ‡∏õ‡πá‡∏ô OUTPUT
  pinMode(RED_PIN, OUTPUT);
  pinMode(GREEN_PIN, OUTPUT);
  pinMode(BLUE_PIN, OUTPUT);
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô)
  digitalWrite(RED_PIN, LOW);
  digitalWrite(GREEN_PIN, LOW);
  digitalWrite(BLUE_PIN, HIGH);
  
  Serial.println("=== MQ-2 Sensor System with MQTT ===");
  
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
  loadConfig();
  
  // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WiFi
  connectWiFi();
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤
  if (WiFi.status() == WL_CONNECTED) {
    configTime(7 * 3600, 0, "pool.ntp.org");
  }
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web Server ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Config
  configServer.on("/", handleRoot);
  configServer.on("/save", HTTP_POST, handleSave);
  configServer.begin();
  Serial.println("‚úÖ Config Server started!");
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ MQTT
  mqtt.setServer(mqtt_server, mqtt_port);
  mqtt.setKeepAlive(60);
  mqtt.setSocketTimeout(30);
  mqtt.setBufferSize(512); // ‡πÄ‡∏û‡∏¥‡πà‡∏° buffer size
  
  Serial.println("MQTT Configuration:");
  Serial.print("Server: ");
  Serial.println(mqtt_server);
  Serial.print("Topic: ");
  Serial.println(mqtt_topic);
  
  // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MQTT
  reconnectMQTT();
  
  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Moving Average Filter
  for (int i = 0; i < numReadings; i++) {
    readings[i] = 0;
  }
  
  // Calibrate baseline (‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ 30 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)
  Serial.println("Calibrating sensor...");
  digitalWrite(BLUE_PIN, HIGH); // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á calibrate
  
  long sum = 0;
  for (int i = 0; i < 30; i++) {
    sum += analogRead(MQ2_PIN);
    delay(100);
  }
  baselineValue = sum / 30;
  isCalibrated = true;
  
  Serial.print("Baseline calibrated: ");
  Serial.print(baselineValue);
  Serial.println(" ADC");
  
  digitalWrite(BLUE_PIN, LOW);
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö)
  for (int i = 0; i < 3; i++) {
    digitalWrite(RED_PIN, LOW);
    digitalWrite(GREEN_PIN, HIGH);
    digitalWrite(BLUE_PIN, LOW);
    delay(200);
    digitalWrite(GREEN_PIN, LOW);
    delay(200);
  }
  
  Serial.println("System Ready!");
}

void loop() {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Power Switch
  if (digitalRead(POWER_SWITCH_PIN) == HIGH) {
    // Switch ‡∏õ‡∏¥‡∏î (OFF) - ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡πÅ‡∏î‡∏á‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö
    digitalWrite(RED_PIN, HIGH);
    digitalWrite(GREEN_PIN, LOW);
    digitalWrite(BLUE_PIN, LOW);
    delay(500);
    digitalWrite(RED_PIN, LOW);
    delay(500);
    return; // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å loop ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠
  }
  
  // Handle Web Server
  configServer.handleClient();
  
  // ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MQTT (‡∏•‡∏≠‡∏á‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
  static unsigned long lastMqttCheck = 0;
  if (!mqtt.connected() && millis() - lastMqttCheck > 5000) {
    reconnectMQTT();
    lastMqttCheck = millis();
  }
  mqtt.loop();
  
  checkResetButton();
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö WiFi
  static unsigned long lastWiFiCheck = 0;
  if (millis() - lastWiFiCheck > 30000) {
    if (WiFi.status() != WL_CONNECTED) {
      Serial.println("WiFi disconnected! Reconnecting...");
      WiFi.reconnect();
    }
    lastWiFiCheck = millis();
  }
  
  // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ Sensor ‡∏û‡∏£‡πâ‡∏≠‡∏° Moving Average Filter
  int rawVal = analogRead(MQ2_PIN);
  
  // ‡∏•‡∏ö baseline ‡∏ó‡∏µ‡πà calibrate ‡πÑ‡∏ß‡πâ
  int instantVal = rawVal - baselineValue;
  if (instantVal < 0) instantVal = 0;
  
  // Moving Average Filter
  total = total - readings[readIndex];
  readings[readIndex] = instantVal;
  total = total + readings[readIndex];
  readIndex = (readIndex + 1) % numReadings;
  average = total / numReadings;
  
  int val = average; // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  lastGasValue = val;
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
  dailyReadings++;
  dailySum += val;
  if (val > dailyMax) {
    dailyMax = val;
  }
  if (val >= 70) {
    exceedCount++;
  }
  
  // ‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 08:00 ‡∏ô.)
  struct tm timeinfo;
  if (getLocalTime(&timeinfo)) {
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô 08:00 ‡∏ô. ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    if (timeinfo.tm_hour == 8 && timeinfo.tm_min == 0 && 
        millis() - lastDailySummary > 3600000) { // ‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô 1 ‡∏ä‡∏°.
      
      int avgValue = (dailyReadings > 0) ? (dailySum / dailyReadings) : 0;
      
      String summary = "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
      summary += "   ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô\n";
      summary += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
      summary += "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: " + sensorLocation + "\n";
      summary += "‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: " + String(avgValue) + " ADC\n";
      summary += "‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: " + String(dailyMax) + " ADC\n";
      summary += "‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå: " + String(exceedCount) + " ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n";
      summary += "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î: " + String(dailyReadings) + " ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n";
      summary += "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: " + getTimestamp() + "\n";
      summary += "Sensor ID: " + sensorId;
      
      sendLineMessage(summary);
      
      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
      dailyReadings = 0;
      dailySum = 0;
      dailyMax = 0;
      exceedCount = 0;
      lastDailySummary = millis();
    }
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Serial Monitor
  Serial.print("MQ-2 Value: ");
  Serial.print(val);
  Serial.print(" ADC | LED: ");
  
  // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏≠‡∏∞‡πÑ‡∏£
  if (val < 70) {
    Serial.println("GREEN");
  } else if (val <= 150) {
    Serial.println("YELLOW");
  } else {
    Serial.println("RED");
  }
  
  // Publish ‡πÑ‡∏õ‡∏¢‡∏±‡∏á MQTT ‡∏ó‡∏∏‡∏Å 200ms
  if (millis() - lastMqttPublish >= mqttPublishInterval) {
    publishSensorData(val);
    lastMqttPublish = millis();
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô LINE
  checkAndSendAlert(val);
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
  // Threshold ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á MQ-2
  // < 70 = ‡∏õ‡∏Å‡∏ï‡∏¥, 70-150 = ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á, > 150 = ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
  
  // ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
  digitalWrite(RED_PIN, LOW);
  digitalWrite(GREEN_PIN, LOW);
  digitalWrite(BLUE_PIN, LOW);
  
  if (val < 70) {
    // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß - ‡∏õ‡∏Å‡∏ï‡∏¥
    digitalWrite(GREEN_PIN, HIGH);
  } 
  else if (val >= 70 && val <= 150) {
    // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á - ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á
    digitalWrite(RED_PIN, HIGH);
    digitalWrite(GREEN_PIN, HIGH);
  } 
  else {
    // ‡∏™‡∏µ‡πÅ‡∏î‡∏á - ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
    digitalWrite(RED_PIN, HIGH);
  }
  
  delay(50); // ‡∏•‡∏î delay ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ MQTT loop ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ö‡πà‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
}

// ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:
// - MQ-2 ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏∏‡πà‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á 20-180 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Ñ‡πà‡∏≤‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£
// - ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 50ms
// - MQTT publish ‡∏ó‡∏∏‡∏Å 200ms ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡πÇ‡∏´‡∏•‡∏î network
