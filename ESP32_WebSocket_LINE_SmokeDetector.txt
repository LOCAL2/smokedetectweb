#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <WebServer.h>
#include <WebSocketsServer.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <time.h>

#define MQ2_AO 34

// ==================== WiFi Config ====================
const char* ssid = "NTWIFI_2.4G";
const char* password = "A987654321";

// ==================== LINE Messaging API ====================
const char* LINE_CHANNEL_TOKEN = "Ov+diNedVgYXZ9vrelGivnHsgTQhyIr9HG30CdjeGljz05Cb8LVPbLCE8EGeeCHjwy1Njdu97p0H6Cfu7a/5jCy1OTKJ3cVKmIDczgPG7r/JAyZ4iFve6kySCq2rDWbri/aLvbU4Ynq/1rc9jEwreQdB04t89/1O/w1cDnyilFU=";

// ==================== Threshold ====================
const int WARNING_THRESHOLD = 150;
const int DANGER_THRESHOLD = 200;

// ==================== Alert Config ====================
const unsigned long LINE_COOLDOWN_MS = 5 * 60 * 1000;
const bool NOTIFY_ON_WARNING = false;
const bool NOTIFY_ON_DANGER = true;
const bool NOTIFY_ON_RECOVERY = true;

// ==================== Location ====================
const char* LOCATION_NAME = "ห้องน้ำสารสนเทศ";
const char* SENSOR_NAME = "Sensor A1";

// ==================== NTP ====================
const char* ntpServer = "pool.ntp.org";
const long gmtOffset_sec = 7 * 3600;

// ==================== Global ====================
WebServer server(80);
WebSocketsServer webSocket = WebSocketsServer(81);

unsigned long lastSend = 0;
unsigned long lastLineAlert = 0;
int currentGasValue = 0;
String lastAlertStatus = "safe";

// ==================== HTML ====================
const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smoke Detector</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #0F172A 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      background: rgba(30, 41, 59, 0.9);
      border-radius: 24px;
      padding: 40px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
      max-width: 400px;
      width: 100%;
    }
    h1 { color: #F8FAFC; font-size: 24px; margin-bottom: 8px; }
    .location { color: #64748B; font-size: 14px; margin-bottom: 30px; }
    .value-container {
      background: rgba(0,0,0,0.3);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
    }
    .value { font-size: 72px; font-weight: 700; color: #10B981; line-height: 1; }
    .unit { color: #64748B; font-size: 18px; margin-top: 8px; }
    .status { padding: 12px 24px; border-radius: 12px; font-weight: 600; font-size: 16px; margin-bottom: 20px; display: inline-block; }
    .safe { background: rgba(16,185,129,0.2); color: #10B981; }
    .warning { background: rgba(245,158,11,0.2); color: #F59E0B; }
    .danger { background: rgba(239,68,68,0.2); color: #EF4444; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
    .timestamp { color: #64748B; font-size: 12px; }
    .line-status { color: #06C755; font-size: 12px; margin-top: 15px; padding: 8px 16px; background: rgba(6, 199, 85, 0.1); border-radius: 8px; display: inline-block; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Smoke Detector</h1>
    <p class="location" id="loc">-</p>
    <div class="value-container">
      <div class="value" id="value">--</div>
      <div class="unit">PPM</div>
    </div>
    <div class="status safe" id="status">Loading...</div>
    <p class="timestamp" id="time">--</p>
    <p class="line-status">LINE Alert: Active</p>
  </div>
  <script>
    var ws = new WebSocket('ws://' + location.hostname + ':81/');
    ws.onmessage = function(e) {
      var d = JSON.parse(e.data);
      document.getElementById('value').textContent = d.value;
      document.getElementById('time').textContent = d.timestamp;
      document.getElementById('loc').textContent = d.location;
      var s = document.getElementById('status');
      var v = document.getElementById('value');
      if (d.value >= 200) {
        s.className = 'status danger'; s.textContent = 'DANGER!'; v.style.color = '#EF4444';
      } else if (d.value >= 50) {
        s.className = 'status warning'; s.textContent = 'WARNING'; v.style.color = '#F59E0B';
      } else {
        s.className = 'status safe'; s.textContent = 'SAFE'; v.style.color = '#10B981';
      }
    };
    ws.onclose = function() { setTimeout(function() { location.reload(); }, 3000); };
  </script>
</body>
</html>
)rawliteral";

// ==================== Functions ====================

String getTimestamp() {
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo)) return "N/A";
  char buf[20];
  strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", &timeinfo);
  return String(buf);
}

String getThaiTime() {
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo)) return "N/A";
  char buf[30];
  strftime(buf, sizeof(buf), "%d/%m/%Y %H:%M:%S", &timeinfo);
  return String(buf);
}

bool sendLineBroadcast(String message) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("[LINE] WiFi not connected");
    return false;
  }
  if (strlen(LINE_CHANNEL_TOKEN) < 50) {
    Serial.println("[LINE] Token not set");
    return false;
  }
  
  Serial.println("[LINE] Connecting...");
  
  WiFiClientSecure* client = new WiFiClientSecure();
  if (!client) {
    Serial.println("[LINE] Memory error");
    return false;
  }
  
  client->setInsecure();
  client->setTimeout(10000);
  
  HTTPClient http;
  http.begin(*client, "https://api.line.me/v2/bot/message/broadcast");
  http.addHeader("Content-Type", "application/json");
  http.addHeader("Authorization", "Bearer " + String(LINE_CHANNEL_TOKEN));
  http.setTimeout(10000);
  
  StaticJsonDocument<512> doc;
  JsonArray messages = doc.createNestedArray("messages");
  JsonObject msg = messages.createNestedObject();
  msg["type"] = "text";
  msg["text"] = message;
  
  String payload;
  serializeJson(doc, payload);
  
  Serial.println("[LINE] Sending...");
  int httpCode = http.POST(payload);
  bool success = (httpCode == 200);
  
  if (success) {
    Serial.println("[LINE] Sent");
  } else {
    Serial.printf("[LINE] Failed: %d\n", httpCode);
  }
  
  http.end();
  delete client;
  return success;
}

// Thai message templates
const char* MSG_DANGER = "\xE0\xB9\x81\xE0\xB8\x88\xE0\xB9\x89\xE0\xB8\x87\xE0\xB9\x80\xE0\xB8\x95\xE0\xB8\xB7\xE0\xB8\xAD\xE0\xB8\x99\xE0\xB8\x84\xE0\xB8\xA7\xE0\xB8\xB1\xE0\xB8\x99 - \xE0\xB8\xAD\xE0\xB8\xB1\xE0\xB8\x99\xE0\xB8\x95\xE0\xB8\xA3\xE0\xB8\xB2\xE0\xB8\xA2";  // แจ้งเตือนควัน - อันตราย
const char* MSG_WARNING = "\xE0\xB9\x81\xE0\xB8\x88\xE0\xB9\x89\xE0\xB8\x87\xE0\xB9\x80\xE0\xB8\x95\xE0\xB8\xB7\xE0\xB8\xAD\xE0\xB8\x99\xE0\xB8\x84\xE0\xB8\xA7\xE0\xB8\xB1\xE0\xB8\x99 - \xE0\xB8\xA3\xE0\xB8\xB0\xE0\xB8\xA7\xE0\xB8\xB1\xE0\xB8\x87";  // แจ้งเตือนควัน - ระวัง
const char* MSG_NORMAL = "\xE0\xB9\x81\xE0\xB8\x88\xE0\xB9\x89\xE0\xB8\x87\xE0\xB9\x80\xE0\xB8\x95\xE0\xB8\xB7\xE0\xB8\xAD\xE0\xB8\x99\xE0\xB8\x84\xE0\xB8\xA7\xE0\xB8\xB1\xE0\xB8\x99 - \xE0\xB8\x9B\xE0\xB8\x81\xE0\xB8\x95\xE0\xB8\xB4";  // แจ้งเตือนควัน - ปกติ
const char* LBL_LOCATION = "\xE0\xB8\xAA\xE0\xB8\x96\xE0\xB8\xB2\xE0\xB8\x99\xE0\xB8\x97\xE0\xB8\xB5\xE0\xB9\x88: ";  // สถานที่:
const char* LBL_SENSOR = "\xE0\xB9\x80\xE0\xB8\x8B\xE0\xB9\x87\xE0\xB8\x99\xE0\xB9\x80\xE0\xB8\x8B\xE0\xB8\xAD\xE0\xB8\xA3\xE0\xB9\x8C: ";  // เซ็นเซอร์:
const char* LBL_VALUE = "\xE0\xB8\x84\xE0\xB9\x88\xE0\xB8\xB2\xE0\xB8\x97\xE0\xB8\xB5\xE0\xB9\x88\xE0\xB8\xA7\xE0\xB8\xB1\xE0\xB8\x94\xE0\xB9\x84\xE0\xB8\x94\xE0\xB9\x89: ";  // ค่าที่วัดได้:
const char* LBL_TIME = "\xE0\xB9\x80\xE0\xB8\xA7\xE0\xB8\xA5\xE0\xB8\xB2: ";  // เวลา:
const char* LBL_CHECK = "\xE0\xB8\x81\xE0\xB8\xA3\xE0\xB8\xB8\xE0\xB8\x93\xE0\xB8\xB2\xE0\xB8\x95\xE0\xB8\xA3\xE0\xB8\xA7\xE0\xB8\x88\xE0\xB8\xAA\xE0\xB8\xAD\xE0\xB8\x9A\xE0\xB8\x9E\xE0\xB8\xB7\xE0\xB9\x89\xE0\xB8\x99\xE0\xB8\x97\xE0\xB8\xB5\xE0\xB9\x88\xE0\xB8\x97\xE0\xB8\xB1\xE0\xB8\x99\xE0\xB8\x97\xE0\xB8\xB5";  // กรุณาตรวจสอบพื้นที่ทันที

void checkAndSendAlert(int value) {
  String currentStatus = "safe";
  
  if (value >= DANGER_THRESHOLD) {
    currentStatus = "danger";
  } else if (value >= WARNING_THRESHOLD) {
    currentStatus = "warning";
  }
  
  unsigned long now = millis();
  bool canSend = (now - lastLineAlert >= LINE_COOLDOWN_MS) || (lastLineAlert == 0);
  
  if (currentStatus != lastAlertStatus) {
    if (currentStatus == "danger" && NOTIFY_ON_DANGER && canSend) {
      String msg = String(MSG_DANGER) + "\n\n";
      msg += String(LBL_LOCATION) + String(LOCATION_NAME) + "\n";
      msg += String(LBL_SENSOR) + String(SENSOR_NAME) + "\n";
      msg += String(LBL_VALUE) + String(value) + " PPM\n";
      msg += String(LBL_TIME) + getThaiTime() + "\n\n";
      msg += String(LBL_CHECK);
      
      if (sendLineBroadcast(msg)) lastLineAlert = now;
    }
    else if (currentStatus == "warning" && NOTIFY_ON_WARNING && canSend) {
      String msg = String(MSG_WARNING) + "\n\n";
      msg += String(LBL_LOCATION) + String(LOCATION_NAME) + "\n";
      msg += String(LBL_SENSOR) + String(SENSOR_NAME) + "\n";
      msg += String(LBL_VALUE) + String(value) + " PPM\n";
      msg += String(LBL_TIME) + getThaiTime();
      
      if (sendLineBroadcast(msg)) lastLineAlert = now;
    }
    else if (currentStatus == "safe" && lastAlertStatus != "safe" && NOTIFY_ON_RECOVERY) {
      String msg = String(MSG_NORMAL) + "\n\n";
      msg += String(LBL_LOCATION) + String(LOCATION_NAME) + "\n";
      msg += String(LBL_SENSOR) + String(SENSOR_NAME) + "\n";
      msg += String(LBL_VALUE) + String(value) + " PPM\n";
      msg += String(LBL_TIME) + getThaiTime();
      
      sendLineBroadcast(msg);
    }
    
    lastAlertStatus = currentStatus;
  }
  else if (currentStatus == "danger" && canSend && NOTIFY_ON_DANGER) {
    String msg = String(MSG_DANGER) + "\n\n";
    msg += String(LBL_LOCATION) + String(LOCATION_NAME) + "\n";
    msg += String(LBL_SENSOR) + String(SENSOR_NAME) + "\n";
    msg += String(LBL_VALUE) + String(value) + " PPM\n";
    msg += String(LBL_TIME) + getThaiTime() + "\n\n";
    msg += String(LBL_CHECK);
    
    if (sendLineBroadcast(msg)) lastLineAlert = now;
  }
}

// ==================== HTTP Handlers ====================

void handleRoot() {
  server.send(200, "text/html", index_html);
}

void handleApi() {
  String json = "{";
  json += "\"id\":\"sensor-001\",";
  json += "\"name\":\"" + String(SENSOR_NAME) + "\",";
  json += "\"location\":\"" + String(LOCATION_NAME) + "\",";
  json += "\"value\":" + String(currentGasValue) + ",";
  json += "\"unit\":\"PPM\",";
  json += "\"timestamp\":\"" + getTimestamp() + "\",";
  json += "\"isOnline\":true";
  json += "}";
  
  server.sendHeader("Access-Control-Allow-Origin", "*");
  server.send(200, "application/json", json);
}

void handleOptions() {
  server.sendHeader("Access-Control-Allow-Origin", "*");
  server.sendHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
  server.sendHeader("Access-Control-Allow-Headers", "Content-Type");
  server.send(204);
}

void webSocketEvent(uint8_t num, WStype_t type, uint8_t* payload, size_t length) {}

// ==================== Setup ====================

void setup() {
  Serial.begin(115200);
  analogReadResolution(12);
  
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) delay(500);
  
  Serial.println("\n================================");
  Serial.println("  Smoke Detector Ready!");
  Serial.println("================================");
  Serial.println("IP: " + WiFi.localIP().toString());
  Serial.println("================================\n");
  
  // Start servers FIRST
  server.on("/", handleRoot);
  server.on("/api/sensor", HTTP_GET, handleApi);
  server.on("/api/sensor", HTTP_OPTIONS, handleOptions);
  server.begin();
  Serial.println("HTTP Server started");
  
  webSocket.begin();
  webSocket.onEvent(webSocketEvent);
  Serial.println("WebSocket started");
  
  // Then sync time (with timeout)
  configTime(gmtOffset_sec, 0, ntpServer);
  struct tm timeinfo;
  int retry = 0;
  while (!getLocalTime(&timeinfo) && retry < 10) {
    delay(500);
    retry++;
  }
  Serial.println("Time synced");
  
  // ส่ง IP ไป LINE ตอนบูต
  String bootMsg = "Smoke Detector Online\n\n";
  bootMsg += "IP: " + WiFi.localIP().toString() + "\n";
  bootMsg += String(LBL_LOCATION) + String(LOCATION_NAME) + "\n";
  bootMsg += String(LBL_TIME) + getThaiTime();
  sendLineBroadcast(bootMsg);
  
  Serial.println("Ready! Try: curl http://" + WiFi.localIP().toString() + "/api/sensor");
}

// ==================== Loop ====================

void loop() {
  server.handleClient();
  webSocket.loop();
  yield(); // ให้ระบบทำงานอื่นได้
  
  if (millis() - lastSend >= 500) {
    lastSend = millis();
    currentGasValue = analogRead(MQ2_AO);
    checkAndSendAlert(currentGasValue);
    
    StaticJsonDocument<256> doc;
    doc["id"] = "sensor-001";
    doc["name"] = SENSOR_NAME;
    doc["location"] = LOCATION_NAME;
    doc["value"] = currentGasValue;
    doc["unit"] = "PPM";
    doc["timestamp"] = getTimestamp();
    doc["isOnline"] = true;
    
    String json;
    serializeJson(doc, json);
    webSocket.broadcastTXT(json);
  }
}